<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maths</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        header {
            background: linear-gradient(135deg, #3a7bd5, #00d2ff);
            color: white;
            text-align: center;
            padding: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        
        #timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e74c3c;
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        #mark-attendance-btn {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
            margin: 1rem 0;
        }
        
        #mark-attendance-btn:hover {
            background: linear-gradient(to right, #27ae60, #219653);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(46, 204, 113, 0.4);
        }
        
        #mark-attendance-btn:active {
            transform: translateY(-1px);
        }
        
        #mark-attendance-btn:disabled {
            background: linear-gradient(to right, #7f8c8d, #95a5a6);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        #attendance-status {
            font-size: 1.2rem;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        a {
            display: inline-block;
            margin-top: 1.5rem;
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        a:hover {
            color: #2980b9;
            background-color: #f8f9fa;
            text-decoration: underline;
            transform: translateY(-2px);
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 16px rgba(46, 204, 113, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);
            }
        }
        
        @media (max-width: 600px) {
            .container {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            #timer {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Maths</h1>
    </header>
    <div class="container">
        <h2>11:00 am to 12:00 pm</h2>
        <div id="timer"></div>
        <button id="mark-attendance-btn" style="display: none;">Mark Attendance</button>
        <p id="attendance-status"></p>
        <br>
        <a href="student.html">Back to Student Portal</a>
    </div>

    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Your Firebase config -->
    <script defer src="firebase.js"></script>

    <!-- Page-specific logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // A small delay to ensure Firebase initializes.
            setTimeout(() => {
                if (typeof firebase === 'undefined' || typeof firebase.database === 'undefined') {
                    console.error('Firebase scripts not loaded or initialized correctly.');
                    alert('Error: Could not connect to Firebase. Please check your configuration and network connection.');
                    return;
                }

                const markAttendanceBtn = document.getElementById('mark-attendance-btn');
                const timerDiv = document.getElementById('timer');
                const statusP = document.getElementById('attendance-status');

                const studentId = 'Student1'; // In a real app, this would be dynamic
                const classId = 'maths';

                // --- Geolocation settings ---
                const maxDistanceMeters = 20; // 20 meters radius

                const attendanceRef = firebase.database().ref(`attendance/${classId}`);
                const statusRef = attendanceRef.child('status');
                const studentStatusRef = attendanceRef.child('students').child(studentId);

                let timerInterval;

                // Function to update status message with appropriate styling
                function updateStatus(message, type = 'info') {
                    statusP.textContent = message;
                    statusP.className = ''; // Clear previous classes
                    statusP.classList.add(`status-${type}`);
                }

                // Add hover effect to the mark attendance button
                markAttendanceBtn.addEventListener('mouseenter', function() {
                    if (!this.disabled) {
                        this.classList.add('pulse');
                    }
                });
                
                markAttendanceBtn.addEventListener('mouseleave', function() {
                    this.classList.remove('pulse');
                });

                markAttendanceBtn.addEventListener('click', () => {
                    if (navigator.geolocation) {
                        updateStatus('Getting your location...', 'info');
                        navigator.geolocation.getCurrentPosition(position => {
                            const studentLat = position.coords.latitude;
                            const studentLon = position.coords.longitude;

                            attendanceRef.once('value').then(snapshot => {
                                const data = snapshot.val();
                                if (data && data.facultyLatitude && data.facultyLongitude) {
                                    const distance = calculateDistance(studentLat, studentLon, data.facultyLatitude, data.facultyLongitude);

                                    if (distance <= maxDistanceMeters) {
                                        studentStatusRef.set(true);
                                        updateStatus('Location verified! Marking attendance...', 'info');
                                    } else {
                                        updateStatus(`You are ${distance.toFixed(2)} meters away from class. Maximum allowed is ${maxDistanceMeters} meters.`, 'error');
                                    }
                                } else {
                                    updateStatus('Could not get faculty location. Please try again.', 'error');
                                }
                            });
                        }, handleLocationError, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        });
                    } else {
                        updateStatus('Geolocation is not supported by this browser.', 'error');
                    }
                });

                function handleLocationError(error) {
                    let message = 'An unknown error occurred.';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            message = "Location permission denied. Please enable it in your browser settings.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = "Location information is unavailable.";
                            break;
                        case error.TIMEOUT:
                            message = "The request to get user location timed out.";
                            break;
                    }
                    updateStatus(`Unable to retrieve your location: ${message}`, 'error');
                }

                statusRef.on('value', (snapshot) => {
                    const status = snapshot.val();
                    if (status === 'open') {
                        updateStatus('Attendance is now open!', 'info');
                        studentStatusRef.get().then(snap => {
                            if (!snap.val()) {
                                markAttendanceBtn.style.display = 'block';
                                markAttendanceBtn.disabled = false;
                                markAttendanceBtn.textContent = 'Mark Attendance';
                            }
                        });

                        attendanceRef.child('endTime').once('value').then((snap) => {
                            const endTime = snap.val();
                            if (endTime) {
                                clearInterval(timerInterval);
                                timerInterval = setInterval(() => updateTimer(endTime), 1000);
                                updateTimer(endTime);
                            }
                        });

                    } else {
                        updateStatus('Attendance is currently closed.', 'info');
                        markAttendanceBtn.style.display = 'none';
                        clearInterval(timerInterval);
                        timerDiv.textContent = '';
                    }
                });

                studentStatusRef.on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        markAttendanceBtn.textContent = 'Attendance Marked';
                        markAttendanceBtn.disabled = true;
                        markAttendanceBtn.classList.remove('pulse');
                        updateStatus('Your attendance has been recorded successfully!', 'success');
                    }
                });

                function updateTimer(endTime) {
                    const now = Date.now();
                    const remainingTime = Math.max(0, endTime - now);

                    if (remainingTime === 0) {
                        timerDiv.textContent = "Time's up!";
                        clearInterval(timerInterval);
                        markAttendanceBtn.disabled = true;
                        markAttendanceBtn.style.display = 'block';
                        return;
                    }
                    
                    const minutes = Math.floor((remainingTime / 1000) / 60);
                    const seconds = Math.floor((remainingTime / 1000) % 60);
                    
                    timerDiv.textContent = `Time remaining: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    
                    // Add visual indication when time is running low
                    if (minutes < 1) {
                        timerDiv.style.color = '#ff4757';
                        timerDiv.style.fontWeight = 'bold';
                    } else {
                        timerDiv.style.color = '#e74c3c';
                    }
                }

                function calculateDistance(lat1, lon1, lat2, lon2) {
                    const R = 6371e3; // metres
                    const φ1 = lat1 * Math.PI/180; // φ, λ in radians
                    const φ2 = lat2 * Math.PI/180;
                    const Δφ = (lat2-lat1) * Math.PI/180;
                    const Δλ = (lon2-lon1) * Math.PI/180;

                    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                              Math.cos(φ1) * Math.cos(φ2) *
                              Math.sin(Δλ/2) * Math.sin(Δλ/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

                    const d = R * c; // in metres
                    return d;
                }

            }, 500); // 500ms delay
        });
    </script>
</body>
</html>